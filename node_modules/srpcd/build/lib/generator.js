"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.getSemantics = void 0;
const grammar_1 = require("./grammar");
const GenerateProto_1 = require("../operations/GenerateProto");
const GenerateNodeServer_1 = require("../operations/GenerateNodeServer");
const GenerateWebClient_1 = require("../operations/GenerateWebClient");
const descriptor_1 = require("../attributes/descriptor");
const fs = require("fs");
function getSemantics(entry, program, root = false) {
    console.log('Compiling [%s]', entry);
    const semantics = grammar_1.grammar.createSemantics();
    let semantic;
    // Attributes
    semantics.addAttribute('descriptor', descriptor_1.descriptor(entry, root, () => semantic, program));
    // Operations
    semantics.addOperation('generateProto', GenerateProto_1.GenerateProto);
    semantics.addOperation('generateNodeServer', GenerateNodeServer_1.GenerateNodeServer);
    semantics.addOperation('generateWebClient', GenerateWebClient_1.GenerateWebClient);
    const contents = fs.readFileSync(entry, 'utf8');
    const r = grammar_1.grammar.match(contents);
    if (!r.succeeded())
        throw new Error(`${r.message} \n ${r.shortMessage}`);
    semantic = semantics(r);
    return semantic;
}
exports.getSemantics = getSemantics;
